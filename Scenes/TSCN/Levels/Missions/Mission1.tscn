[gd_scene load_steps=40 format=3 uid="uid://dh0cluhw5hbar"]

[ext_resource type="Script" uid="uid://b5lp2yd4sopow" path="res://Scripts/Level/MissionScript.gd" id="1_314ux"]
[ext_resource type="Script" uid="uid://dd7sv4ths4dth" path="res://Scripts/Level/EnvironmentEffects.gd" id="2_3fu4r"]
[ext_resource type="AudioStream" uid="uid://bdjdysj3l46f7" path="res://Assets/SFX/Wind.ogg" id="2_8qye6"]
[ext_resource type="Script" uid="uid://bn44me3sxajlb" path="res://Scripts/Skeleton/Nodes/Ingame/LocalGameTimeSaver.gd" id="2_mcejo"]
[ext_resource type="Texture2D" uid="uid://vuyq5s7dknal" path="res://Assets/Art/Level/SandTexture.png" id="3_kali0"]
[ext_resource type="PackedScene" uid="uid://5g1k55gpynrt" path="res://Scenes/TSCN/Entities/Diver/Diver.tscn" id="4_0aydx"]
[ext_resource type="Script" uid="uid://cqr2vbfidme0q" path="res://Scripts/Components/Multiplayer/MultiplayerPlayerSpawnerComponent.gd" id="4_iytd7"]
[ext_resource type="AudioStream" uid="uid://cqn1ekjfcc0fx" path="res://Assets/Music/Sunlight.mp3" id="5_3fu4r"]
[ext_resource type="Script" uid="uid://xurg5qfsdg1m" path="res://Scripts/Objects/AutoTerrain.gd" id="5_aep54"]
[ext_resource type="PackedScene" uid="uid://6ajyn7xeilmv" path="res://Scenes/TSCN/Entities/Submarine/SmallSub.tscn" id="12_mcejo"]
[ext_resource type="PackedScene" uid="uid://brtj1ur8tgigg" path="res://Scenes/ResearchStation.tscn" id="13_eg3rs"]
[ext_resource type="Script" uid="uid://dkv3wdadaqub7" path="res://Scripts/Level/EnemySpawner.gd" id="15_gg62y"]
[ext_resource type="Script" uid="uid://dbwht88doa5vw" path="res://Scripts/ResourceScripts/Misc/EnemySpawnerInfo.gd" id="16_4wjdw"]
[ext_resource type="PackedScene" uid="uid://dk5y5253vbhe4" path="res://Scenes/TSCN/Entities/NPCS/Jellyfish.tscn" id="16_cbdp8"]
[ext_resource type="Script" uid="uid://bcfo5ahloonou" path="res://Scripts/ResourceScripts/Misc/UIDContainer.gd" id="17_j8dce"]
[ext_resource type="PackedScene" uid="uid://bptkxkfwbumm5" path="res://Scenes/TSCN/Entities/NPCS/BigfinSquid.tscn" id="18_0qmxr"]
[ext_resource type="Script" uid="uid://bled6xgnlmdd7" path="res://Scripts/Components/Misc/BuoyancyComponent.gd" id="21_pr3qq"]
[ext_resource type="Texture2D" uid="uid://ctwe161d8x2ne" path="res://Assets/Art/Misc/Bubble.png" id="22_l3b62"]
[ext_resource type="PackedScene" uid="uid://71htappd3cxj" path="res://Scenes/TSCN/UI/IngameUi.tscn" id="29_54jb5"]
[ext_resource type="PackedScene" uid="uid://c1oaylh32r500" path="res://Scenes/TSCN/UI/SettingsMenu.tscn" id="30_ec8ks"]
[ext_resource type="PackedScene" uid="uid://blcwv5ro6f2ce" path="res://Scenes/TSCN/UI/DeathScreen.tscn" id="32_kyt52"]
[ext_resource type="PackedScene" uid="uid://ci1hceptj3hwn" path="res://Scenes/TSCN/UI/MissionSuccessScreen.tscn" id="33_aiin4"]
[ext_resource type="PackedScene" uid="uid://co2canly84hyf" path="res://Scenes/TSCN/Entities/NPCS/Leviathan.tscn" id="35_47o3q"]
[ext_resource type="PackedScene" uid="uid://c1sxg2d10k1y7" path="res://Scenes/TSCN/UI/PauseMenu.tscn" id="35_upo23"]

[sub_resource type="NavigationPolygon" id="NavigationPolygon_jsraf"]
outlines = Array[PackedVector2Array]([PackedVector2Array(-7158, -8735, 30252, -8582, 30713, 12105, -7849, 12336)])
source_geometry_mode = 1
source_geometry_group_name = &"obstacles"
agent_radius = 41.62

[sub_resource type="GDScript" id="GDScript_5py2y"]
script/source = "extends NavigationRegion2D

func _ready() -> void:
	while true:
		bake_navigation_polygon()
		await get_tree().create_timer(0.5).timeout
"

[sub_resource type="Shader" id="Shader_c3wo4"]
code = "shader_type canvas_item;
render_mode world_vertex_coords;

uniform vec2 points[50];
uniform int num_points;
uniform vec2 global_position;
uniform int fade_width;
uniform float tex_scale;
uniform float color_multiplier;

uniform sampler2D in_tex : repeat_enable;
uniform sampler2D edge_tex : repeat_enable;

varying vec2 world_pos;

void vertex() {
	world_pos = VERTEX;
}

void fragment() {
	vec2 position = world_pos;
	vec2 closest_point_pos = vec2(0.0, 0.0);
	float closest_point_dist = 999999999.0;

	for (int i = 0; i < num_points; i++) {
		if (i >= 50) {
			continue;
		}
		
		int to_use = i - 1;
		if (i == 0) {
			to_use = num_points - 1;
		}

		vec2 p1 = global_position + points[i];
		vec2 p2 = global_position + points[to_use];

		vec2 p = position - p1;
		vec2 n = p2 - p1;
		float l2 = dot(n, n);

		float d = dot(n, p) / l2;
		vec2 closest_point;

		if (d <= 0.0) {
			closest_point = p1;
		}
		else if (d >= 1.0f) {
			closest_point = p2;
		}
		else {
			closest_point = p1 + n * d;
		}

		float dist = distance(position, closest_point);

		if (dist < closest_point_dist) {
			closest_point_pos = closest_point;
			closest_point_dist = dist;
		}
	}

	float fade_amm = clamp(closest_point_dist / float(fade_width), 0.0, 1.0);

	vec4 in_pixel = texture(in_tex, position / tex_scale);
	vec4 edge_pixel = texture(edge_tex, position / tex_scale);

	COLOR = vec4(mix(edge_pixel, in_pixel, fade_amm).rgb * color_multiplier, 1.0);
}"

[sub_resource type="Gradient" id="Gradient_l7jee"]
offsets = PackedFloat32Array(0.0192308)
colors = PackedColorArray(0.663023, 0.427097, 0.199698, 1)

[sub_resource type="GradientTexture1D" id="GradientTexture1D_dhgix"]
gradient = SubResource("Gradient_l7jee")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_2sekr"]
resource_local_to_scene = true
shader = SubResource("Shader_c3wo4")
shader_parameter/points = PackedVector2Array(-6592, -112, -6543, 320, -6500, 365, -6403, 393, -6159, 398, -5328, 435, -4544, 454, -4310, 469, -4076, 496, -3842, 563, -3612, 673, -3432, 782, -3235, 964, -3067, 1261, -2929, 1578, -2647, 2424, -2257, 3037, -1798, 3487, -1335, 3823, -802, 4137, -130, 4372, 724, 4529, 1318, 4587, 2704, 4677, 6698, 4820, 7695, 4842, 8011, 4858, 8255, 4887, 8485, 4933, 8692, 4996, 8869, 5093, 8993, 5220, 9087, 5378, 9183, 5637, 9164.54, 5629.71, 9143.79, 5621.52, 9117.06, 5610.97, 9099.5, 5604.04, 9080.47, 5596.53, 9060.71, 5588.73, 9033.99, 5578.18, 9007.12, 5567.57, 8987.65, 5559.89, 8965.45, 5551.12, 8941.02, 5541.48, 8918.52, 5532.6, 8894.7, 5523.2, 8880.32, 5517.52, 8883, 5513, 8867, 5507, 8131, 5099, 5090, 5248, 3962.85, 5982.79, 3761.88, 8075.19, 6759.56, 9876.11, 11676, 10320, 10611, 11196, -7048, 11272, -6700, 368)
shader_parameter/num_points = 59
shader_parameter/global_position = Vector2(0, 0)
shader_parameter/fade_width = 215
shader_parameter/tex_scale = 103.0
shader_parameter/color_multiplier = 0.4
shader_parameter/in_tex = SubResource("GradientTexture1D_dhgix")
shader_parameter/edge_tex = ExtResource("3_kali0")

[sub_resource type="Resource" id="Resource_eg3rs"]
resource_local_to_scene = true
script = ExtResource("17_j8dce")
uid = 3625

[sub_resource type="Resource" id="Resource_xdqqp"]
script = ExtResource("16_4wjdw")
scene = ExtResource("16_cbdp8")
group_size = 1
probability = 10

[sub_resource type="Resource" id="Resource_a077w"]
script = ExtResource("16_4wjdw")
scene = ExtResource("18_0qmxr")
group_size = 1
probability = 4

[sub_resource type="Resource" id="Resource_2j7sg"]
script = ExtResource("16_4wjdw")
scene = ExtResource("35_47o3q")
group_size = 1
probability = 2

[sub_resource type="Environment" id="Environment_5ulyy"]
background_mode = 3
background_canvas_max_layer = 10
glow_enabled = true
glow_levels/1 = 0.3
glow_levels/2 = 0.3
glow_levels/3 = 0.4
glow_levels/4 = 0.3
glow_levels/5 = 0.5
glow_levels/6 = 0.2
glow_blend_mode = 0

[sub_resource type="ViewportTexture" id="ViewportTexture_gnvk0"]
viewport_path = NodePath("Light and stuff/Bubbles/BubblesViewport")

[sub_resource type="Curve" id="Curve_6rk86"]
_data = [Vector2(0, 0), 0.0, 23.2523, 0, 0, Vector2(0.125645, 1), 0.0, 0.0, 0, 0, Vector2(1, 0), 0.185794, 0.0, 0, 0]
point_count = 3

[sub_resource type="CurveTexture" id="CurveTexture_pq4a2"]
curve = SubResource("Curve_6rk86")

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_hcosd"]
particle_flag_disable_z = true
particle_flag_damping_as_friction = true
emission_shape = 3
emission_box_extents = Vector3(960, 540, 1)
gravity = Vector3(0, -98, 0)
damping_min = 1.0
damping_max = 1.0
scale_min = 0.3
scale_max = 0.8
scale_curve = SubResource("CurveTexture_pq4a2")
collision_mode = 2
collision_use_scale = true

[node name="Mission1" type="Node2D"]
script = ExtResource("1_314ux")

[node name="GlobalVariableSaver" type="Node" parent="."]
script = ExtResource("2_mcejo")

[node name="LevelContainer" type="Node2D" parent="."]

[node name="Environment" type="Node2D" parent="LevelContainer"]

[node name="EnvironmentEffects" type="Node" parent="LevelContainer/Environment"]
script = ExtResource("2_3fu4r")

[node name="Wind" type="AudioStreamPlayer" parent="LevelContainer/Environment/EnvironmentEffects"]
stream = ExtResource("2_8qye6")
autoplay = true
bus = &"Wind"
parameters/looping = true

[node name="Music" type="AudioStreamPlayer" parent="LevelContainer/Environment/EnvironmentEffects"]
stream = ExtResource("5_3fu4r")
volume_db = -80.0
autoplay = true
bus = &"Music"

[node name="Collisions" type="NavigationRegion2D" parent="LevelContainer/Environment" groups=["obstacles"]]
z_index = 2
position = Vector2(-10165, -10896)
navigation_polygon = SubResource("NavigationPolygon_jsraf")
script = SubResource("GDScript_5py2y")

[node name="World" type="Node2D" parent="LevelContainer/Environment/Collisions"]
position = Vector2(11006, 34721)

[node name="Terrain1" type="Polygon2D" parent="LevelContainer/Environment/Collisions/World"]
material = SubResource("ShaderMaterial_2sekr")
position = Vector2(-7958, -33141)
scale = Vector2(0.4, 0.4)
polygon = PackedVector2Array(-16102, -6397, -10730.5, -14054.5, -12680.5, -16324.5, -10835.5, -19392, -2505.5, -19292, -7068, -11859.5, -1830.5, -10439.5, 4579.5, -11087, -1233, -5424.5, -4625.5, 785.502, -8580.5, 1333, -10825.5, -1509.5, -12745.5, -161.998, -14721, 1452, -13796, 9374, -10181, 9442, -13917, 11918, -13135, 14785, -10322, 17194, -5115, 15961, -3628, 18320, 4084, 18736, 8248, 11064, 7782, 16437, 8288, 17897, 10148, 19744, 14951, 20383, 18841, 17436, 17879, 13068, 13139, 10374, 21138, 9781, 27991, 6580, 24800, 13281, 24105, 15820, 26569, 17479, 37124, 19129, 44553, 18478, 50121, 15768, 51965, 18138, 54651, 18191, 55178, 14451, 52175, 10289, 54515, 6540, 55438, 1560, 55243, -3796, 46896, -2850, 42220, -5271, 39290, -7645, 41166.5, -7977.33, 40752, -12701, 43111, -7910, 45027, -7738, 47901, -6657, 51243, -7099, 53826, -10442, 53174, -13071, 50074, -15890, 46192, -16995, 41108, -17037, 43947, -19458, 51539, -18939, 56306, -14073, 57651, -9647, 59680, -5081, 61487, 22886, -18849, 22932, -18689, 7663)
script = ExtResource("5_aep54")

[node name="Terrain2" type="Polygon2D" parent="LevelContainer/Environment/Collisions/World"]
material = SubResource("ShaderMaterial_2sekr")
position = Vector2(-6685, -34034)
scale = Vector2(0.4, 0.4)
polygon = PackedVector2Array(-10349, 12965, -7198, 11175, -4549, 9337, -2329, 6855, -488, 2610, 642, -1596, 4509, 1292, 3328, 4563, 2254, 8302, 1028, 10138, 292, 14821, -1780, 12345, -4090, 13802, -7413, 15400, -9848, 14970)
script = ExtResource("5_aep54")

[node name="Terrain3" type="Polygon2D" parent="LevelContainer/Environment/Collisions/World"]
material = SubResource("ShaderMaterial_2sekr")
position = Vector2(-6924, -34328)
scale = Vector2(0.4, 0.4)
polygon = PackedVector2Array(10813, 9119, 7152, 5916, 7581, -260, 3358, -5336, 13647, -4405, 21953, -4900, 23259, -8641, 26754, -5857, 31431, -6014, 28594, -2087, 28827, 3114, 25240, 6094, 25468, 3272, 23829, 177, 17944, -1524, 13776, -1004, 10670, 1284, 9726, 5116)
script = ExtResource("5_aep54")

[node name="Terrain4" type="Polygon2D" parent="LevelContainer/Environment/Collisions/World"]
material = SubResource("ShaderMaterial_2sekr")
position = Vector2(2450, -24105)
scale = Vector2(0.4, 0.4)
polygon = PackedVector2Array(6462, -15589, 8254, -13956, 4770, -8829, 12089, -13838, 21181, -12501, 23787, -14721, 23787, -19788, 9502, -18244)
script = ExtResource("5_aep54")

[node name="Player" type="Node2D" parent="LevelContainer"]

[node name="MultiplayerPlayerSpawnerComponent" type="Node" parent="LevelContainer/Player"]
script = ExtResource("4_iytd7")
spawn_filepath = "res://Scenes/TSCN/Entities/Diver/Diver.tscn"

[node name="Diver" parent="LevelContainer/Player/MultiplayerPlayerSpawnerComponent" instance=ExtResource("4_0aydx")]
z_index = 20
position = Vector2(-963, 308)
uid = SubResource("Resource_eg3rs")

[node name="Submarine" parent="LevelContainer/Player" instance=ExtResource("12_mcejo")]
position = Vector2(-1315, 1706)

[node name="BuoyancyComponent" type="Node" parent="LevelContainer/Player/Submarine"]
script = ExtResource("21_pr3qq")
buoyancy_accel = 0.0

[node name="ResearchStation" parent="LevelContainer" instance=ExtResource("13_eg3rs")]
position = Vector2(-11403, -5944)
metadata/_edit_lock_ = true

[node name="Items" type="Node2D" parent="LevelContainer"]

[node name="Entities" type="Node2D" parent="LevelContainer"]

[node name="EnemySpawner" type="Node2D" parent="LevelContainer/Entities"]
script = ExtResource("15_gg62y")
player_view_dist = 1500
enemy_close_dist = 2500
draw_spawn_positions = true
enemy_list = Array[ExtResource("16_4wjdw")]([SubResource("Resource_xdqqp"), SubResource("Resource_a077w"), SubResource("Resource_2j7sg")])

[node name="Background" type="ColorRect" parent="LevelContainer"]
offset_left = -16513.0
offset_top = -19959.0
offset_right = 18529.0
offset_bottom = 1221.0
color = Color(0.0312209, 0.0673709, 0.274788, 1)
metadata/_edit_lock_ = true

[node name="UILayer" type="CanvasLayer" parent="."]
layer = 3

[node name="IngameUI" parent="UILayer" instance=ExtResource("29_54jb5")]
metadata/_edit_lock_ = true

[node name="ChatPanel" parent="UILayer/IngameUI/StatsAndChatDraggable/StatsAndChat/ChatPanelDraggable" index="1" node_paths=PackedStringArray("teleport_places", "enemy_root")]
teleport_place_names = Array[String](["research-station", "submarine"])
teleport_places = [null, null]
enemy_root = NodePath("../../../../../../LevelContainer/Entities/EnemySpawner")

[node name="DeathScreen" parent="UILayer" node_paths=PackedStringArray("ingame_ui") instance=ExtResource("32_kyt52")]
visible = false
ingame_ui = NodePath("../IngameUI")

[node name="MissionSuccessScreen" parent="UILayer" node_paths=PackedStringArray("ingame_ui") instance=ExtResource("33_aiin4")]
visible = false
ingame_ui = NodePath("../IngameUI")

[node name="PauseMenu" parent="UILayer" node_paths=PackedStringArray("ingame_ui") instance=ExtResource("35_upo23")]
visible = false
ingame_ui = NodePath("../IngameUI")

[node name="Settings" parent="UILayer" instance=ExtResource("30_ec8ks")]
process_mode = 2
visible = false

[node name="Light and stuff" type="Node2D" parent="."]

[node name="WorldEnvironment" type="WorldEnvironment" parent="Light and stuff"]
environment = SubResource("Environment_5ulyy")

[node name="CanvasModulate" type="CanvasModulate" parent="Light and stuff"]
color = Color(0, 0, 0, 1)

[node name="DirectionalLight2D" type="DirectionalLight2D" parent="Light and stuff"]
editor_only = true

[node name="Bubbles" type="ParallaxBackground" parent="Light and stuff"]
layer = 0

[node name="BubblesLayer1" type="ParallaxLayer" parent="Light and stuff/Bubbles"]
motion_scale = Vector2(2, 2)
motion_mirroring = Vector2(1920, 1080)
metadata/_edit_lock_ = true

[node name="TextureRect" type="TextureRect" parent="Light and stuff/Bubbles/BubblesLayer1"]
offset_right = 40.0
offset_bottom = 40.0
scale = Vector2(1.5, 1.5)
texture = SubResource("ViewportTexture_gnvk0")
metadata/_edit_use_anchors_ = true
metadata/_edit_lock_ = true

[node name="BubblesLayer2" type="ParallaxLayer" parent="Light and stuff/Bubbles"]
motion_scale = Vector2(1.3, 1.3)
motion_mirroring = Vector2(1920, 1080)
metadata/_edit_lock_ = true

[node name="TextureRect" type="TextureRect" parent="Light and stuff/Bubbles/BubblesLayer2"]
offset_right = 40.0
offset_bottom = 40.0
texture = SubResource("ViewportTexture_gnvk0")
metadata/_edit_use_anchors_ = true

[node name="BubblesLayer3" type="ParallaxLayer" parent="Light and stuff/Bubbles"]
motion_scale = Vector2(0.7, 0.7)
motion_mirroring = Vector2(1920, 1080)
metadata/_edit_lock_ = true

[node name="TextureRect" type="TextureRect" parent="Light and stuff/Bubbles/BubblesLayer3"]
offset_right = 40.0
offset_bottom = 40.0
scale = Vector2(0.6, 0.6)
texture = SubResource("ViewportTexture_gnvk0")

[node name="BubblesViewport" type="SubViewport" parent="Light and stuff/Bubbles"]
transparent_bg = true
use_hdr_2d = true
size = Vector2i(1920, 1080)

[node name="BubbleParticles" type="GPUParticles2D" parent="Light and stuff/Bubbles/BubblesViewport"]
position = Vector2(960, 540)
texture = ExtResource("22_l3b62")
lifetime = 5.0
visibility_rect = Rect2(-960, -540, 1920, 1080)
process_material = SubResource("ParticleProcessMaterial_hcosd")

[editable path="UILayer/IngameUI"]
