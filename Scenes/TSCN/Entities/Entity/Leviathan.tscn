[gd_scene load_steps=7 format=3 uid="uid://co2canly84hyf"]

[ext_resource type="Script" path="res://Scripts/Components/Rope/FabrikRope.gd" id="1_7l8up"]
[ext_resource type="PackedScene" uid="uid://dwxcjl4jrkyw3" path="res://Scenes/TSCN/Entities/Entity/LeviathanNode.tscn" id="1_ljr6s"]
[ext_resource type="Script" path="res://Scripts/ResourceScripts/EntityBehavior/EnemyBehaviorSettings.gd" id="1_txg70"]
[ext_resource type="Script" path="res://Scripts/Components/Rope/RopeAttachment.gd" id="4_6mv3f"]

[sub_resource type="GDScript" id="GDScript_pigha"]
script/source = "## This is a big fish enemy
# Owned by: kaitaobenson

class_name Leviathan
extends Enemy

@export var LEVIATHAN_NODE: PackedScene

@export var node_amount: int = 100
@export var node_separation: float = 30.0

@onready var start_node: LeviathanNode = $\"Head\"
@onready var rope: FabrikRope = $\"FabrikRope\"

var leviathan_nodes: Array[LeviathanNode]

func _ready() -> void:
	_ready_enemy()
	
	# Set rope data
	rope.point_amount = node_amount
	rope.point_separation = node_separation
	rope.start_pos_on = true
	rope._ready_rope()
	
	# Add in leviathan nodes
	leviathan_nodes.append(start_node)
	
	for i in range(rope.point_amount - 2):
		var new_node: LeviathanNode = LEVIATHAN_NODE.instantiate()
		
		add_child(new_node)
		leviathan_nodes.append(new_node)

func _process(delta: float) -> void:
	_process_enemy(delta)

func _physics_process(delta: float) -> void:
	update_leviathan_nodes()
	
	velocity = (target_position - position).normalized() * 200
	global_position += velocity * delta

func update_leviathan_nodes() -> void:
	rope.start_pos_on = true
	rope.start_pos = global_position
	
	for i in range(rope.point_amount - 1):
		leviathan_nodes[i].global_position = rope.points[i]
		if i == 0:
			leviathan_nodes[i].global_rotation = rope.points[i].angle_to_point(target_position)
		else:
			leviathan_nodes[i].global_rotation = rope.points[i].angle_to_point(rope.points[i - 1])
"

[sub_resource type="Resource" id="Resource_mnlvr"]
script = ExtResource("1_txg70")
health = 100
damage = 5
base_speed = 100.0
agressiveness = 1.0
attack_distance = 5.0
closest_distance = 5.0
sensor_type = 0
wander_type = 0
attack_mode = 0
wander_range = 100.0
view_range = 360.0
view_distance = 1000.0
disable_period_length = 1.0
sound_max_distance = 0.0

[node name="Leviathan" type="CharacterBody2D"]
motion_mode = 1
script = SubResource("GDScript_pigha")
LEVIATHAN_NODE = ExtResource("1_ljr6s")
settings = SubResource("Resource_mnlvr")

[node name="Head" parent="." instance=ExtResource("1_ljr6s")]

[node name="Polygon2D" parent="Head" index="0"]
polygon = PackedVector2Array(-40, 2, -38, -32, -18, -36, 7, -43, 26, -35, 44, -12, 44, 17, 25, 38, 1, 39, -31, 35)

[node name="Polygon2D3" type="Polygon2D" parent="Head"]
position = Vector2(-36, -9)
scale = Vector2(1.1, 0.486486)
color = Color(0, 0, 1, 1)
polygon = PackedVector2Array(47.4545, -41.3333, 72, 3.88889, 50.1818, -4.33334, 39.2727, -6.38889)

[node name="Polygon2D2" type="Polygon2D" parent="Head"]
position = Vector2(-29, -11)
color = Color(0, 0, 1, 1)
polygon = PackedVector2Array(50, 16, 72, 8, 50, 45, 42, 33)

[node name="FabrikRope" type="Node2D" parent="."]
script = ExtResource("1_7l8up")
component_container = NodePath("..")

[node name="Legs? wtf" type="Node2D" parent="."]

[node name="RopeAttachment" type="Node2D" parent="Legs? wtf" node_paths=PackedStringArray("rope")]
script = ExtResource("4_6mv3f")
rope = NodePath("../../FabrikRope")
rope_node_index = 3
attachment_pos = Vector2(100, 0)

[node name="ColorRect" type="ColorRect" parent="Legs? wtf/RopeAttachment"]
offset_right = 40.0
offset_bottom = 40.0
color = Color(1, 1, 0.27451, 1)
metadata/_edit_use_anchors_ = true

[node name="RopeAttachment2" type="Node2D" parent="Legs? wtf" node_paths=PackedStringArray("rope")]
script = ExtResource("4_6mv3f")
rope = NodePath("../../FabrikRope")
rope_node_index = 3
attachment_pos = Vector2(-100, 0)

[node name="ColorRect" type="ColorRect" parent="Legs? wtf/RopeAttachment2"]
offset_right = 40.0
offset_bottom = 40.0
color = Color(1, 1, 0.27451, 1)
metadata/_edit_use_anchors_ = true

[node name="RopeAttachment3" type="Node2D" parent="Legs? wtf" node_paths=PackedStringArray("rope")]
script = ExtResource("4_6mv3f")
rope = NodePath("../../FabrikRope")
rope_node_index = 29
attachment_pos = Vector2(100, 0)

[node name="ColorRect" type="ColorRect" parent="Legs? wtf/RopeAttachment3"]
offset_right = 40.0
offset_bottom = 40.0
color = Color(1, 1, 0.27451, 1)
metadata/_edit_use_anchors_ = true

[node name="RopeAttachment4" type="Node2D" parent="Legs? wtf" node_paths=PackedStringArray("rope")]
script = ExtResource("4_6mv3f")
rope = NodePath("../../FabrikRope")
rope_node_index = 29
attachment_pos = Vector2(-100, 0)

[node name="ColorRect" type="ColorRect" parent="Legs? wtf/RopeAttachment4"]
offset_right = 40.0
offset_bottom = 40.0
color = Color(1, 1, 0.27451, 1)
metadata/_edit_use_anchors_ = true

[editable path="Head"]
